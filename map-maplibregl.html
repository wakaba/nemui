<!DOCTYPE HTML>
<html>
  <meta charset=utf-8>
  <title>Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
<link rel=stylesheet href=https://pawjy.github.io/html-unit-number/css/default.css>
<link rel=stylesheet href=https://pawjy.github.io/html-page-components/css/default.css>
<style>
  body {
    margin: 1em;
  }
  p {
    margin: 0;
  }
  .buttons {
    display: flex;
    flex-wrap: wrap;
  }
  map-area {
    height: 40em;
    /*--paco-map-touch-scroll-viewport: none;*/
    /*--paco-map-zoom-animation: none;*/
  }
  map-area[formcontrol] {
    /*--paco-marker-value: circle red 1000m green 2px;*/
  }
  x-1, x-2, x-3, x-4 {
    position: absolute;
    display: block;
    border: 5px solid gray;
    min-width: 10px;
    min-height: 10px;
  }
  x-2 { border-color: blue }
  x-3 { border-color: green }
  x-4 { border-color: red }
</style>
<script src=https://pawjy.github.io/html-page-components/src/page-components.js data-export=$fill async></script>
<script src=../html-page-components/src/maps.js onerror='let s = document.createElement("script");s.src="https://pawjy.github.io/html-page-components/src/maps.js";document.head.appendChild(s)' async></script>
<script src=https://wiki.suikawiki.org/scripts/time async data-time-selector=time></script>
<script src=https://pawjy.github.io/html-unit-number/src/unit-number.js async></script>
<script src=https://raw.githack.com/wakaba/js-geo-encodedpolyline/master/encodedpolyline.js></script>
<script src=../js-routes/src/routes.js onerror='let s = document.createElement("script");s.src="https://raw.githack.com/geocol/js-routes/refs/heads/master/src/routes.js";document.head.appendChild(s)' async></script>
<script src=https://raw.githack.com/geocol/js-routes/refs/heads/master/src/routepoints.js></script>

  <section id=map-section-1 lang=ja>
    <map-area engine=maplibre controls="type typebuttons scale fullscreen currentposition zoom streetview togglelegend coordinates pitch" maptype=osm-gsi-hillshade+gsi-optimal_bvmap-label pitch=35 terrain=1.8 gsi jma osm lat=35.2 lon=135.4 zoom=12 formcontrol>
      <map-controls>ABC</map-controls>
      <map-controls position=top-left>XYZ</map-controls>
      <map-controls position=top-left><button>xyz</button></map-controls>
      <map-controls position=top-center>123</map-controls>
      <map-controls position=top-left legend>A legend</map-controls>
      <map-controls position=top-left>Not a legend</map-controls>
    </map-area>

    <p class=buttons>
      <button value=gsi-standard onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">standard</button>
      <button value=gsi-english onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">english</button>
      <button value=gsi-english-standard onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">english/standard</button>
      <button value=gsi-lang onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">lang-dependent</button>
      <button value=gsi-hillshade onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">hillshade</button>
      <button value=gsi-photo onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">photo</button>
      <button value=gsi-standard-hillshade onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">standard+hillshade</button>
      <button value=gsi-hillshade-standard onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">hillshade+standard</button>
      <button value=gsi-photo-standard onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">photo+standard</button>
      <button value=none onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">none</button>
      <button value=B13/TBB onclick="
        document.querySelector('map-area').setMapType('himawari:'+this.value);
      ">himawari (B13/TBB)</button>
      <button value=B03/ALBD onclick="
        document.querySelector('map-area').setMapType('himawari:'+this.value);
      ">himawari (B03/ALBD)</button>
      <button value=B08/TBB onclick="
        document.querySelector('map-area').setMapType('himawari:'+this.value);
      ">himawari (B08/TBB)</button>
      <button value=REP/ETC onclick="
        document.querySelector('map-area').setMapType('himawari:'+this.value);
      ">himawari (REP/ETC)</button>
      <button value=SND/ETC onclick="
        document.querySelector('map-area').setMapType('himawari:'+this.value);
      ">himawari (SND/ETC)</button>
      <button value=B13/TBB onclick="
        document.querySelector('map-area').setMapType('himawari+gsi-standard:'+this.value);
      ">himawari+gsi-standard (B13/TBB)</button>
      <button value=B03/ALBD onclick="
        document.querySelector('map-area').setMapType('himawari+gsi-standard:'+this.value);
      ">himawari+gsi-standard (B03/ALBD)</button>
      <button value=B08/TBB onclick="
        document.querySelector('map-area').setMapType('himawari+gsi-standard:'+this.value);
      ">himawari+gsi-standard (B08/TBB)</button>
      <button value=REP/ETC onclick="
        document.querySelector('map-area').setMapType('himawari+gsi-standard:'+this.value);
      ">himawari+gsi-standard (REP/ETC)</button>
      <button value=SND/ETC onclick="
        document.querySelector('map-area').setMapType('himawari+gsi-standard:'+this.value);
      ">himawari+gsi-standard (SND/ETC)</button>
      <button value=jma-umimesh-wind onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">jma-umimesh-wind</button>
      <button value=jma-umimesh-wind+gsi-standard onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">jma-umimesh-wind+gsi-standard</button>
      <button value=osm onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">osm</button>
      <button value=osm-gsi-hillshade onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">osm-gsi-hillshade</button>
      <button value=osm-gsi-hillshade+gsi-optimal_bvmap-label onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">osm-gsi-hillshade+gsi-optimal_bvmap-label</button>
      <button value=osm-gsi-hillshade+gsi-optimal_bvmap-contour-label onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">osm-gsi-hillshade+gsi-optimal_bvmap-contour-label</button>
      <button value=gsi-optimal_bvmap onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">gsi-optimal_bvmap</button>
      <button value=gsi-optimal_bvmap-hillshade onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">gsi-optimal_bvmap-hillshade</button>
      <button value=gsi-optimal_bvmap-nocontour-hillshade onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">gsi-optimal_bvmap-nocontour-hillshade</button>
      <button value=gsi-photo-optimal_bvmap onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">gsi-photo-optimal_bvmap</button>
      <button value=gsi-photo-optimal_bvmap-nocontour onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">gsi-photo-optimal_bvmap-nocontour</button>
      <button value=gsi-hillshade-optimal_bvmap onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">gsi-hillshade-optimal_bvmap</button>
      <button value=gsi-hillshade-optimal_bvmap-nocontour onclick="
        document.querySelector('map-area').setMapType(this.value);
      ">gsi-hillshade-optimal_bvmap-nocontour</button>
      <button value=SND/ETC onclick="
        document.querySelector('map-area').setMapType('himawari+gsi-optimal_bvmap:'+this.value);
      ">himawari+gsi-optimal_bvmap (SND/ETC)</button>

      <input id=latlon onfocus=this.select() onchange="
        var [lat, lon] = this.value.split (/,/);
        var m = document.querySelector ('map-area');
        m.setAttribute ('lat', lat);
        m.setAttribute ('lon', lon);
      ">
    <p>
      <output name=bounds></output>
    <p>
      <output name=value></output>
    <script>
    (() => {
      var testRenderCount = 0;
      var s = document.querySelector ('#map-section-1');
      s.querySelector ('map-area').addEventListener ('pcRedraw', (ev) => {
        var o = s.querySelector ('output[name=bounds]');
        var b = ev.target.getMapBounds ();
        let zoom = ev.target.pcZoomLevel;
        if (b) o.textContent = [b.north, b.east, b.south, b.west, zoom,
                                ev.target.pc_Bearing,
                                ev.target.pc_Pitch].join (' ');

        var c = ev.target.getMapCenter ();
        document.querySelector ('#latlon').value = c.lat + ',' + c.lon;
        
        var n = ++testRenderCount;
        ev.target.setMouseHandlers ({
          mousedown: obj => {
            console.log (n, "mousedown", obj.getMouseButton (), obj.getPoint ());
          },
          mousemove: obj => {
            //console.log (n, "mousemove", obj.getMouseButton (), obj.getPoint ());
          },
          mouseup: obj => {
            console.log (n, "mouseup", obj.getMouseButton (), obj.getPoint ());
          },
        });
      });
      s.querySelector ('map-area').addEventListener ('change', (ev) => {
        var o = s.querySelector ('output[name=value]');

        var v = ev.target.valueAsLatLon;
        o.textContent = [v.lat, v.lon, null];

        console.pcMaps.getElevation (v.lat, v.lon).then (elevation => {
          o.textContent = [v.lat, v.lon, elevation];
        });
      });
    }) ();
    </script>

      <input type=range min=0 value=1.8 max=5 step=0.1 oninput="
        var map = document.querySelector ('map-area');
        map.setAttribute ('terrain', this.value);
        nextElementSibling.value = value;
      ">
      <output name=current_terrain>1.8</output>
    <p>
      <button type=button onclick="
        parentNode.parentNode.querySelector ('map-area').noMapDraggable = false;
      ">Draggable</button>
      <button type=button onclick="
        parentNode.parentNode.querySelector ('map-area').noMapDraggable = true;
      ">Non-draggable</button>
      <button type=button onclick="
        var map = document.querySelector ('map-area');
        var e1 = document.createElement ('x-1');
        var e2 = document.createElement ('x-2');
        var e3 = document.createElement ('x-3');
        var e4 = document.createElement ('x-4');
        var pp = map.addElementOverlays ({
          background: e1, foreground: e2, tooltip: e3, interactive: e4,
        }, () => {
          var center = map.getMapCenter ();
          var p1 = pp.getProjection ().divPoint (center);
          e1.style.left = p1.x + 'px';
          e1.style.top = p1.y + 'px';
          
          e2.style.left = p1.x + 100 + 'px';
          e2.style.top = p1.y + 'px';
          
          e3.style.left = p1.x + 'px';
          e3.style.top = p1.y + 100 + 'px';
          
          e4.style.left = p1.x + 100 + 'px';
          e4.style.top = p1.y + 100 + 'px';
        });
      ">addElementOverlays</button>

      
    <p>
      <input-datetime oninput="
        var map = document.querySelector ('map-area');
        map.explicitTime = querySelector ('input[type=checkbox]').checked ? this.value : null;
      ">
        <input type=checkbox>
        <input type=date>
        <input type=time>

        <input type=range name=event-time-range step=60 oninput="
          parentNode.value = this.valueAsNumber;
        " style="width: 50%">
      </input-datetime>
      <label><input type=checkbox name=animated> ▶</label>
      <select onchange="timeFactor = parseFloat (value)">
        <option value=1>等倍速 1s/s
        <option value=100>100倍速 100s/s
        <option value=300>5分/s
        <option value=600 selected>10分/s
        <option value=3600>1時間/s
      </select>
      <button type=button onclick="
        let map = document.querySelector ('map-area');
        map.setAttribute ('maptype', 'osm-gsi-hillshade+gsi-optimal_bvmap-label');
        setTimeout (() => {
        map.setAttribute ('zoom', 9);
        map.setAttribute ('pitch', 40);
        document.querySelector ('[name=animated]').checked = true;
        let time = document.querySelector ('[name=event-time-range]');
        time.value = parseFloat (time.min) + (time.max - time.min) / 3;
        time.dispatchEvent (new Event ('input', {bubbles: true}));
        }, 1000);
      ">A0</button>
      <button type=button onclick="
        let map = document.querySelector ('map-area');
        map.setAttribute ('maptype', 'gsi-photo-optimal_bvmap-nocontour');
        setTimeout (() => {
        map.setAttribute ('zoom', 12);
        map.setAttribute ('pitch', 50);
        document.querySelector ('[name=animated]').checked = true;
        let time = document.querySelector ('[name=event-time-range]');
        time.value = parseFloat (time.min) + (time.max - time.min) / 3;
        time.dispatchEvent (new Event ('input', {bubbles: true}));
        }, 1000);
      ">A1</button>
      <button type=button onclick="
        let map = document.querySelector ('map-area');
        map.setAttribute ('maptype', 'osm-gsi-hillshade+gsi-optimal_bvmap-label');
        setTimeout (() => {
        map.setAttribute ('zoom', 12);
        map.setAttribute ('pitch', 40);
        document.querySelector ('[name=animated]').checked = true;
        let time = document.querySelector ('[name=event-time-range]');
        time.value = parseFloat (time.min);
        time.dispatchEvent (new Event ('input', {bubbles: true}));
        }, 1000);
      ">A2</button>
      <button type=button onclick="
        let map = document.querySelector ('map-area');
        map.setAttribute ('maptype', 'osm-gsi-hillshade+gsi-optimal_bvmap-label');
        setTimeout (() => {
        map.setAttribute ('zoom', 12);
        map.setAttribute ('pitch', 40);
        document.querySelector ('[name=animated]').checked = true;
        document.querySelector ('[name=track_by_rank]').checked = true;
        document.querySelector ('[name=tracked_rank]').value = 1;
        let time = document.querySelector ('[name=event-time-range]');
        time.value = parseFloat (time.min);
        time.dispatchEvent (new Event ('input', {bubbles: true}));
        }, 1000);
      ">A3</button>
    <p>
      <input type=url name=ibukiURL onchange="
        setURL (value, {initiator: 'input'});
      " style="width: 100%">
      <progress hidden></progress>
      <span class=tracked-team-info>
        <unit-number type=rank unit=位 data-field=rank></unit-number>
        <bdi data-field=td.short_label></bdi>
        <bdi data-field=td.label></bdi>
      </span>
      <input type=checkbox name=track_by_rank>
      <input type=number name=tracked_rank value=1 min=1 step=1 required>

  <script src=map1.js></script>
  <script>
      let ibukiURL = null;
      let newRequest = true;
      {
        let sp = new URLSearchParams (location.hash.replace (/^#/, ''));
        let ib = sp.get ('ibuki');
        if (ib) setURL (ib, {initiator: 'hash'});
        let mt = sp.get ('map');
        if (mt) document.querySelector ('map-area').setAttribute ('maptype', mt);
      }

      document.querySelector ('map-area').addEventListener ('pcMapTypeChange', () => {
        if (ibukiURL) {
          showIbukiEventByURL (ibukiURL, {new: newRequest});
          newRequest = false;
          updateURL ();
        }
      });

      function setURL (u, opts) {
        if (/\/ev\/[0-9]+\//.test (u)) {
          ibukiURL = u;
          newRequest = true;
          if (showIbukiEventByURL (ibukiURL, {new: newRequest})) {
            newRequest = false;
          }
          if (opts.initiator !== 'hash') updateURL ();
          if (opts.initiator !== 'input') document.querySelectorAll ('input[name=ibukiURL]').forEach (_ => _.value = ibukiURL);
        } else {
          throw new Error ("Bad URL: " + u);
        }
      } // setURL

      function updateURL () {
        let mt = document.querySelector ('map-area').pcMapType;
        history.replaceState (null, null, '#ibuki=' + encodeURIComponent (ibukiURL) + '&map=' + encodeURIComponent (mt));
      }
    </script>
      
    <hr style="margin-top: 10em">

    <form>
      <input type=number name=lat value=0 step=0.0001>
      <input type=number name=lon value=0 step=0.0001>
      <button type=button onclick="
        document.querySelector ('map-area').pcScroll ({
          center: {lat: form.elements.lat.value,
                   lon: form.elements.lon.value},
        });
      ">setCenter</button>
      <button type=button onclick="
        document.querySelector ('map-area').pcScroll ({
          center: {lat: form.elements.lat.value,
                   lon: form.elements.lon.value},
          setValue: true,
        });
      ">setCenter + setValue</button>
      <button type=button onclick="
        document.querySelector ('map-area').pcScroll ({
          center: {lat: form.elements.lat.value,
                   lon: form.elements.lon.value},
          intoView: true,
        });
      ">setCenter + scrollIntoView</button>
      <button type=button onclick="
        document.querySelector ('map-area').pcScroll ({
          center: {lat: form.elements.lat.value,
                   lon: form.elements.lon.value},
          intoView: true,
          ifNeeded: true,
        });
      ">setCenter + scrollIntoViewIfNeeded</button>
      <button type=button onclick="
        document.querySelector ('map-area').pcScroll ({
          bounds: {north: form.elements.lat.valueAsNumber,
                   west: form.elements.lon.valueAsNumber,
                   south: form.elements.lat.valueAsNumber + 1,
                   east: form.elements.lon.valueAsNumber + 1,
                   },
        });
      ">setBounds</button>
    </form>

    <hr style="margin-top: 10em">

    <p><map-area engine=maplibre gsi controls style="height:28em"></map-area>
    <p><map-area engine=maplibre controls style="height:17em"></map-area>
    <p><map-area engine=maplibre controls=coordinates style="height:17em"></map-area>
  </section>
