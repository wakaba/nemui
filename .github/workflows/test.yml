{
   "jobs" : {
      "test" : {
         "env" : {
            "CIRCLE_ARTIFACTS" : "/tmp/circle-artifacts/test"
         },
         "runs-on" : "ubuntu-latest",
         "steps" : [
            {
               "uses" : "actions/checkout@v2",
               "with" : {
                  "ssh-key" : "${{ secrets.GH_GIT_KEY }}"
               }
            },
            {
            "run": "echo \"$GH_GIT_KEY\" | tr -d '\r' > /tmp/git.key && chmod 600 /tmp/git.key && eval $(ssh-agent -s) && ssh-add /tmp/git.key",
               "env" : {
                  "GH_GIT_KEY" : "${{ secrets.GH_GIT_KEY }}"
               }
          },
            {
               "run" : "mkdir -p $CIRCLE_ARTIFACTS"
            },
            {
               "run" : "make build-for-docker",
               "env" : {
                  "DDSDDATA_GIT" : "${{ secrets.DDSDDATA_GIT }}",
                  "GIT_SSH_COMMAND": "ssh -i /tmp/git.key"
               }
            },
            {
               "run" : "docker build -t $DDSDRUN_DOCKER_IMAGE \u005C.",
               "env" : {
                  "DDSDRUN_DOCKER_IMAGE" : "${{ secrets.DDSDRUN_DOCKER_IMAGE }}"
               }
            },
            {
               "env" : {
                  "DOCKER_PASS" : "${{ secrets.DOCKER_PASS }}",
                  "DOCKER_USER" : "${{ secrets.DOCKER_USER }}"
               },
               "if" : "${{ github.ref == 'refs/heads/ddsdrun' }}",
               "run" : "docker login -u $DOCKER_USER -p $DOCKER_PASS quay.io"
            },
            {
               "if" : "${{ github.ref == 'refs/heads/ddsdrun' }}",
               "run" : "docker push $DDSDRUN_DOCKER_IMAGE",
               "env" : {
                  "DDSDRUN_DOCKER_IMAGE" : "${{ secrets.DDSDRUN_DOCKER_IMAGE }}"
               }
            },
            {
               "env" : {
                  "BWALLER_URL" : "${{ secrets.BWALLER_URL }}",
                  "DDSDRUN_DOCKER_IMAGE" : "${{ secrets.DDSDRUN_DOCKER_IMAGE }}"
               },
               "if" : "${{ github.ref == 'refs/heads/ddsdrun' }}",
               "run" : "curl -sSf $BWALLER_URL | BWALL_GROUP=docker BWALL_NAME=$DDSDRUN_DOCKER_IMAGE bash"
            },
            {
               "if" : "${{ always () }}",
               "uses" : "actions/upload-artifact@v3",
               "with" : {
                  "path" : "/tmp/circle-artifacts/test"
               }
            }
         ]
      }
   },
   "name" : "test",
   "on" : {
      "push" : {
      }
   }
}
